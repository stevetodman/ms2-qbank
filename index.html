<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MS2 Mini‚ÄëQBank ‚Äî Structural Congenital Heart Disease (40 items)</title>
  <meta name="theme-color" content="#0b0c10">
  <link rel="manifest" href="manifest.json">
  <style>
    :root{
      --bg: #0b0c10;
      --card: #111218;
      --ink: #f5f7fa;
      --muted: #a9b0be;
      --accent: #66d9ef;
      --good: #3fb950;
      --bad: #f85149;
      --warn: #f2cc60;
      --chip: #21242e;
      --border: #1e2230;
      --focus: #6aa3ff;
    }
    [data-theme="light"]{
      --bg: #f7f9fc;
      --card: #ffffff;
      --ink: #0b1220;
      --muted: #4a5568;
      --accent: #2563eb;
      --good: #15803d;
      --bad: #b91c1c;
      --warn: #b45309;
      --chip: #eef2f7;
      --border: #e2e8f0;
      --focus: #2563eb;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font: 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    header{
      position:sticky; top:0; z-index:5;
      backdrop-filter:saturate(1.2) blur(6px);
      background: linear-gradient(180deg, rgba(11,12,16,.85), rgba(11,12,16,.6));
      border-bottom:1px solid var(--border);
      padding: 12px 16px;
      display:flex; align-items:center; gap:14px; flex-wrap:wrap;
    }
    [data-theme="light"] header{
      background: linear-gradient(180deg, rgba(247,249,252,.92), rgba(247,249,252,.8));
    }
    header h1{font-size:18px; margin:0; letter-spacing: .2px;}
    header .pill{
      background: var(--chip);
      border:1px solid var(--border);
      padding: 6px 10px; border-radius: 999px; color: var(--muted); font-size:13px;
    }
    .wrap{
      display:grid;
      grid-template-columns: 300px 1fr;
      gap: 16px;
      padding: 16px;
      max-width: 1400px;
      margin: 0 auto;
    }
    aside{
      position:sticky; top:64px; align-self:start;
      background: var(--card); border:1px solid var(--border);
      border-radius: 12px; padding: 14px;
    }
    aside h2{font-size:14px; margin: 6px 0 6px; color: var(--muted); font-weight:600; text-transform:uppercase; letter-spacing:.7px}
    aside .group{margin:10px 0 14px; display:flex; flex-direction:column; gap:8px}
    aside label{display:flex; align-items:center; gap:8px; font-size:14px; color: var(--ink); cursor:pointer}
    aside input[type="checkbox"], aside input[type="radio"]{accent-color: var(--focus)}
    aside .chips{display:flex; gap:8px; flex-wrap:wrap; max-height: 180px; overflow:auto; padding-right:4px}
    .chip{
      background: var(--chip); border:1px solid var(--border);
      border-radius: 999px; padding: 4px 10px; font-size: 13px; color: var(--muted);
      cursor:pointer; user-select:none;
    }
    .chip.active{ color: var(--ink); border-color: var(--focus)}
    .btn{
      appearance:none; border:1px solid var(--border); background: #161821; color: var(--ink);
      padding: 10px 12px; border-radius: 10px; font-weight:600; cursor:pointer;
    }
    [data-theme="light"] .btn{ background:#f3f6fb }
    .btn:hover{border-color: var(--focus)}
    .btn.primary{ background: #1c2230; border-color:#2a3650}
    [data-theme="light"] .btn.primary{ background:#e8eefc; border-color:#c7d2fe }
    .btn.good{ background:#0f2215; border-color:#0f3c17; color:#c7f5d2}
    .btn.bad{ background:#2a0f12; border-color:#4a1117; color:#ffd3d3}
    .btn.warn{ background:#2a2310; border-color:#5a4b1a; color:#ffecc0}
    .btn.ghost{ background:transparent}
    .stack{display:flex; gap:8px; flex-wrap:wrap}
    .question-card{
      background: var(--card); border:1px solid var(--border); border-radius: 14px;
      padding: 16px; min-height: 300px;
    }
    .question-meta{display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; color: var(--muted); font-size: 13px}
    .question-meta .flag{cursor:pointer; padding: 4px 8px; border-radius:6px; border:1px solid var(--border); background: var(--chip)}
    .question-stem{font-size:18px; margin:10px 0 12px; white-space:pre-wrap}
    .options{display:flex; flex-direction:column; gap:10px}
    .option{
      display:flex; align-items:flex-start; gap:12px; padding: 12px;
      border:1px solid var(--border); border-radius:10px; cursor:pointer;
      transition: background .15s ease, border-color .15s ease;
      background:#12131a;
    }
    [data-theme="light"] .option{ background:#f8fafc }
    .option:hover{border-color: var(--focus)}
    .option .letter{width:28px; height:28px; border-radius:50%; border:1px solid var(--border); display:flex; align-items:center; justify-content:center; font-weight:700; color: var(--muted); flex: 0 0 28px}
    .option .text{flex:1}
    .option.selected{border-color:#3a4a6d; background:#141a24}
    [data-theme="light"] .option.selected{ background:#eef2ff; border-color:#c7d2fe }
    .option.correct{border-color: var(--good); background: #102115}
    [data-theme="light"] .option.correct{ background:#dcfce7; border-color:#86efac }
    .option.incorrect{border-color: var(--bad); background: #221115}
    [data-theme="light"] .option.incorrect{ background:#fee2e2; border-color:#fecaca }
    .answer-strip{display:flex; gap:10px; align-items:center; margin-top:12px}
    .explanation{
      margin-top: 14px; padding: 12px; border:1px dashed var(--border); border-radius: 10px; background:#10121a; color: #e8ecf7;
      display:none;
    }
    [data-theme="light"] .explanation{ background:#f1f5f9; color:#0b1220 }
    .explanation.show{display:block}
    .tags{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
    .tag{font-size:12px; background:#141622; border:1px solid var(--border); color: var(--muted); border-radius:999px; padding:3px 8px}
    [data-theme="light"] .tag{ background:#eef2f7; color:#384152 }
    footer{max-width: 1400px; margin: 16px auto; color: var(--muted); font-size:12px; padding: 0 16px 24px}
    .stat{display:flex; gap:12px; flex-wrap:wrap}
    .kpi{background: var(--card); border:1px solid var(--border); border-radius:12px; padding:12px; min-width: 150px}
    .progress{height:8px; background:#141622; border:1px solid var(--border); border-radius:999px; overflow:hidden}
    [data-theme="light"] .progress{ background:#eef2f7 }
    .progress > div{height:100%; background: linear-gradient(90deg, #66d9ef, #7ee787)}
    .small{font-size:12px; color: var(--muted)}
    .toolbar{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
    .search{display:flex; align-items:center; gap:8px; background:#11131a; border:1px solid var(--border); border-radius:10px; padding:8px 10px}
    [data-theme="light"] .search{ background:#ffffff }
    .search input{background:transparent; border:0; outline:0; color: var(--ink); width:200px}
    .search .clear{border:0; background:transparent; cursor:pointer; font-weight:700; color:var(--muted)}
    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; background:#0c0e14; border:1px solid #1b2030; border-bottom-color:#0f1420; border-radius:6px; padding:2px 6px; color:#b4c0d9; font-size:12px}
    [data-theme="light"] .kbd{ background:#eef2ff; color:#334155; border-color:#c7d2fe }
    .hidden{display:none}

    /* Visually-hidden (for accessible radios) */
    .visually-hidden{
      position:absolute!important; width:1px; height:1px; padding:0; margin:-1px;
      overflow:hidden; clip:rect(0 0 0 0); white-space:nowrap; border:0;
    }

    /* Focus styles for keyboard users */
    .btn:focus-visible, .option:focus-visible, .chip:focus-visible, .flag:focus-visible, input[type="radio"]:focus-visible{
      outline: 2px solid var(--focus); outline-offset: 2px;
    }

    /* Toast for gentle notices */
    #toast{
      position:fixed; bottom:16px; right:16px;
      background: var(--card); color: var(--ink); border:1px solid var(--border);
      padding:10px 12px; border-radius:8px; box-shadow:0 4px 14px rgba(0,0,0,.4);
      opacity:0; pointer-events:none; transition:opacity .2s ease; z-index:9999;
    }
    #toast.show{opacity:1}

    @media (prefers-reduced-motion: reduce){
      *{ transition: none !important; animation: none !important; }
    }

    @media (max-width: 980px){
      .wrap{grid-template-columns: 1fr}
      aside{position: static}
    }

    @media print{
      header, aside, .answer-strip, #tagList, #examSummary .stack, footer{ display:none !important; }
      body{ background:#fff; color:#000; }
      .question-card{ border:0 }
    }
  </style>
  <script>
    // Register service worker for offline/PWA
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function(){
        navigator.serviceWorker.register('./sw.js').catch(()=>{});
      });
    }
  </script>
</head>
<body>
<header>
  <h1>MS2 Mini‚ÄëQBank ‚Äî Structural Congenital Heart Disease</h1>
  <span class="pill">40 items</span>
  <!-- Exam timer (starts on first submitted answer) -->
  <span id="timerPill" class="pill hidden" aria-live="polite">‚è± 00:00</span>
  <div class="toolbar">
    <span class="small">Mode:</span>
    <label class="pill"><input type="radio" name="mode" value="practice" checked> Practice</label>
    <label class="pill"><input type="radio" name="mode" value="exam"> Exam (answers at end)</label>
    <button class="btn" id="shuffleBtn" title="Shuffle current set (R)">Shuffle</button>
    <button class="btn" id="reviewWrongBtn" title="Start session with your last incorrect answers">Review mistakes</button>
    <div class="search" role="search">
      üîé <input id="searchBox" placeholder="Search stem/tags‚Ä¶" aria-label="Search">
      <button id="clearSearch" class="clear" title="Clear search" aria-label="Clear search">√ó</button>
    </div>
    <button class="btn ghost" id="exportBtn" title="Export progress (JSON)">Export</button>
    <button class="btn ghost" id="importBtn" title="Import progress (JSON)">Import</button>
    <button class="btn ghost" id="resetBtn" title="Clear progress">Reset</button>
    <button class="btn ghost" id="themeBtn" title="Toggle light/dark theme">üåì Theme</button>
  </div>
</header>

<div class="wrap">
  <aside>
    <h2>Filters</h2>
    <div class="group" id="moduleFilters"></div>
    <div class="group">
      <label><input type="checkbox" id="onlyUnseen"> Only unseen</label>
      <label><input type="checkbox" id="onlyFlagged"> Only flagged</label>
    </div>
    <h2>Tags</h2>
    <div class="chips" id="tagChips"></div>
    <div class="group">
      <button class="btn good" id="startBtn">Start Session</button>
      <button class="btn" id="prevBtn" title="Previous (‚Üê)">‚Üê Prev</button>
      <button class="btn" id="nextBtn" title="Next (‚Üí)">Next ‚Üí</button>
    </div>
    <div class="group">
      <h2>Shortcuts</h2>
      <div class="small">
        <div><span class="kbd">1‚Äì5</span> choose ‚Ä¢ <span class="kbd">Enter</span> submit ‚Ä¢ <span class="kbd">‚Üí</span> next ‚Ä¢ <span class="kbd">F</span> flag ‚Ä¢ <span class="kbd">E</span> explanation ‚Ä¢ <span class="kbd">R</span> shuffle</div>
      </div>
    </div>
    <div class="group">
      <h2>Your Stats</h2>
      <div class="stat" id="statBar">
        <div class="kpi">
          <div class="small">Seen</div>
          <div id="seenCount" style="font-weight:700; font-size:20px">0</div>
        </div>
        <div class="kpi">
          <div class="small">Accuracy</div>
          <div id="accPct" style="font-weight:700; font-size:20px">‚Äî</div>
          <div class="progress"><div id="accBar" style="width:0%"></div></div>
        </div>
      </div>
      <div id="filterStats" class="small" style="margin-top:8px"></div>
    </div>
  </aside>

  <main>
    <div class="question-card" aria-live="off">
      <div class="question-meta">
        <div>
          <span id="qCounter" class="small">‚Äî / ‚Äî</span> ¬∑
          <span id="qModule" class="small"></span>
        </div>
        <div>
          <button class="flag small" id="flagBtn" aria-pressed="false">‚öë Flag</button>
        </div>
      </div>
      <div id="qStem" class="question-stem"></div>
      <div id="options" class="options" role="radiogroup" aria-label="Answer choices"></div>

      <div class="answer-strip">
        <button class="btn primary" id="submitBtn">Submit</button>
        <button class="btn" id="showExplainBtn" aria-controls="explain" aria-expanded="false">Show explanation</button>
        <div id="correctness" class="small" aria-live="polite" aria-atomic="true"></div>
      </div>

      <div id="explain" class="explanation"></div>
      <div id="tagList" class="tags"></div>
    </div>

    <section id="examSummary" class="hidden" style="margin-top:16px">
      <div class="question-card">
        <h2>Exam Summary</h2>
        <div id="examStats"></div>
        <div id="breakdown"></div>
        <div style="margin-top:10px" class="stack">
          <button class="btn good" id="reviewIncorrectBtn">Review incorrect only</button>
          <button class="btn" id="restartBtn">Restart</button>
        </div>
      </div>
    </section>
  </main>
</div>

<footer>
  <p><strong>About.</strong> A portable, single‚Äëfile QBank for MS2 students on structural congenital heart disease. Runs offline in any modern browser. Progress is saved locally (no accounts; no data leaves your device).</p>
  <p class="small">Content is educational, not medical advice. Keyboard navigation: <span class="kbd">1‚Äì5</span>, <span class="kbd">Enter</span>, <span class="kbd">‚Üê/‚Üí</span>, <span class="kbd">F</span>, <span class="kbd">E</span>, <span class="kbd">R</span>.</p>
</footer>

<!-- Toast container -->
<div id="toast" role="status" aria-live="polite"></div>

<script>
// ---------- SETTINGS ----------
const AUTO_EXPLAIN_WRONG_ONLY = true; // When true, show explanation automatically only if answer was wrong in practice

// ---------- DATA ----------
/** Each item: {id, number, module, topic, stem, options[], answer_index, explanation, tags[]} */
const QUESTIONS = [/* truncated in this builder for brevity; replaced at runtime */];
</script>

<script>
// Insert the full QUESTIONS array at runtime to keep the main script readable in this builder output.
</script>

<script>
// ---------- ACTUAL DATA (expanded) ----------
/** Each item: {id, number, module, topic, stem, options[], answer_index, explanation, tags[]} */
const FULL_QUESTIONS = [
  {
    id: 1,
    number: 1,
    module: "Module 1: Embryology",
    topic: "Embryology",
    stem: "A medical student is studying cardiac development and learns that the aorticopulmonary septum must spiral as it divides the truncus arteriosus to ensure proper ventriculoarterial connections. Failure of this spiral pattern during weeks five to seven of gestation would most likely result in which of the following congenital heart defects?",
    options: [
      "Tetralogy of Fallot",
      "Transposition of the great arteries",
      "Truncus arteriosus",
      "Ventricular septal defect",
      "Atrial septal defect"
    ],
    answer_index: 1,
    explanation: "Transposition of the great arteries results from failure of the aorticopulmonary septum to develop in the normal spiral pattern during truncoconal septation. When the septum forms in a straight rather than spiral configuration, the aorta arises from the morphologic right ventricle and the pulmonary artery from the left ventricle, creating discordant ventriculoarterial connections and two parallel circulations. This error occurs during weeks five to seven of gestation when neural crest cells migrate into the outflow tract.",
    tags: ["Transposition","embryology","truncoconal septation","neural crest"]
  },
  {
    id: 2,
    number: 2,
    module: "Module 1: Embryology",
    topic: "Embryology",
    stem: "A neonate is born with a large defect in the lower atrial septum adjacent to the atrioventricular valves, and echocardiography demonstrates a cleft in the anterior mitral valve leaflet. The infant's karyotype reveals trisomy 21. Which embryologic structure failed to develop properly to produce this combination of defects?",
    options: [
      "Septum primum",
      "Septum secundum",
      "Endocardial cushions",
      "Sinus venosus",
      "Truncus arteriosus"
    ],
    answer_index: 2,
    explanation: "Primum atrial septal defect with cleft mitral valve represents partial atrioventricular septal defect due to failure of the endocardial cushions to fuse properly. Cushions contribute to the lower atrial septum, upper ventricular septum, and septal leaflets of the mitral/tricuspid valves. Strongly associated with trisomy 21.",
    tags: ["AVSD","primum ASD","endocardial cushions","Down syndrome","embryology"]
  },
  {
    id: 3,
    number: 3,
    module: "Module 2: Fetal Physiology",
    topic: "Fetal Physiology",
    stem: "A neonatologist performs a hyperoxia test on a cyanotic newborn by administering 100% oxygen for 10 minutes and obtaining an arterial blood gas. The pre‚Äëtest PaO‚ÇÇ is 45 mm Hg, and the post‚Äëtest value is 50 mm Hg. Which of the following is the most likely diagnosis?",
    options: [
      "Respiratory distress syndrome",
      "Transient tachypnea of the newborn",
      "Meconium aspiration syndrome",
      "Transposition of the great arteries",
      "Pneumonia"
    ],
    answer_index: 3,
    explanation: "In pulmonary disease, supplemental oxygen typically raises arterial PaO‚ÇÇ >150 mm Hg. In cyanotic congenital heart disease with significant right‚Äëto‚Äëleft shunt, oxygenation changes minimally. The minimal rise from 45‚Üí50 mm Hg points to intracardiac shunting; classic for transposition of the great arteries.",
    tags: ["Hyperoxia test","cyanosis","transposition","pulmonary disease differential"]
  },
  {
    id: 4,
    number: 4,
    module: "Module 2: Transitional Physiology",
    topic: "Transitional Physiology",
    stem: "A six‚Äëmonth‚Äëold infant presents with cyanosis limited to the lower extremities and toes, with visible clubbing of the toenails but normal appearance of the fingers. The upper extremities have normal oxygen saturation of 98%, while the lower extremities have saturations of 78%. Which of the following is the most likely diagnosis?",
    options: [
      "Tetralogy of Fallot",
      "Atrial septal defect with Eisenmenger syndrome",
      "Patent ductus arteriosus with Eisenmenger syndrome",
      "Persistent pulmonary hypertension of the newborn",
      "Transposition of the great arteries"
    ],
    answer_index: 2,
    explanation: "Differential cyanosis (toes blue, fingers pink) is pathognomonic for PDA with Eisenmenger. When PVR exceeds SVR, shunt reverses right‚Äëto‚Äëleft. Because the ductus joins the descending aorta distal to the left subclavian, desaturated blood perfuses only the lower body.",
    tags: ["Differential cyanosis","Eisenmenger syndrome","patent ductus arteriosus","physical examination"]
  },
  {
    id: 5,
    number: 5,
    module: "Module 2: Fetal Physiology",
    topic: "Fetal Physiology",
    stem: "During fetal life, which statement best describes the relative contributions of the ventricles to combined cardiac output?",
    options: [
      "The left ventricle contributes ‚âà two‚Äëthirds",
      "The right ventricle contributes ‚âà two‚Äëthirds",
      "Both ventricles contribute equally",
      "The left ventricle contributes >90%",
      "The right ventricle contributes < one‚Äëthird"
    ],
    answer_index: 1,
    explanation: "In fetal circulation the right ventricle is dominant, handling ~two‚Äëthirds of combined output. High fetal PVR sends most RV output across the ductus arteriosus to the descending aorta.",
    tags: ["Fetal circulation","ventricular output","ductus arteriosus physiology"]
  },
  {
    id: 6,
    number: 6,
    module: "Module 3: Atrial Septal Defect",
    topic: "Atrial Septal Defect",
    stem: "A 7‚Äëyear‚Äëold girl is asymptomatic but has a systolic murmur. S2 is widely split and does not vary with respiration. ECG shows right axis deviation and rsR' in V1. Which diagnosis is most likely?",
    options: [
      "Secundum atrial septal defect",
      "Primum atrial septal defect",
      "Ventricular septal defect",
      "Patent ductus arteriosus",
      "Pulmonic stenosis"
    ],
    answer_index: 0,
    explanation: "Fixed wide splitting of S2 with R' in V1 reflects RV volume overload ‚Üí classic for secundum ASD. Primum ASD typically has left axis deviation; VSD has a holosystolic murmur; PDA has a continuous murmur; isolated PS widens but does not fix S2.",
    tags: ["Secundum ASD","fixed split S2","physical exam","ECG"]
  },
  {
    id: 7,
    number: 7,
    module: "Module 3: Ventricular Septal Defect",
    topic: "Ventricular Septal Defect",
    stem: "A 2‚Äëmonth‚Äëold with poor weight gain, diaphoresis with feeds, and tachypnea has a holosystolic murmur at the left lower sternal border. CXR shows cardiomegaly with increased pulmonary vascular markings. The infant was well at birth. Which best explains the delayed presentation?",
    options: [
      "The ventricular septal defect enlarged after birth",
      "Pulmonary vascular resistance decreased over the first weeks of life",
      "The ductus arteriosus closed at 6 weeks of age",
      "Left ventricular function progressively deteriorated",
      "Right ventricular hypertrophy developed gradually"
    ],
    answer_index: 1,
    explanation: "Large nonrestrictive VSDs become symptomatic at 6‚Äì8 weeks as PVR falls to near‚Äëadult levels ‚Üí left‚Äëto‚Äëright shunt increases ‚Üí pulmonary overcirculation and CHF.",
    tags: ["Ventricular septal defect","pulmonary vascular resistance","transitional physiology","CHF timing"]
  },
  {
    id: 8,
    number: 8,
    module: "Module 3: Patent Ductus Arteriosus",
    topic: "Patent Ductus Arteriosus",
    stem: "A premature infant (30 weeks) has respiratory distress and a continuous murmur at the left upper sternal border with bounding pulses. Which medication facilitates ductal closure?",
    options: [
      "Prostaglandin E1",
      "Indomethacin",
      "Digoxin",
      "Furosemide",
      "Dopamine"
    ],
    answer_index: 1,
    explanation: "Indomethacin (or ibuprofen) inhibits prostaglandin synthesis and promotes closure of PDA in premature infants. PGE1 maintains patency and is used for ductal‚Äëdependent lesions.",
    tags: ["Patent ductus arteriosus","indomethacin","prematurity","prostaglandins"]
  },
  {
    id: 9,
    number: 9,
    module: "Module 3: Atrioventricular Septal Defect",
    topic: "Atrioventricular Septal Defect",
    stem: "A 3‚Äëmonth‚Äëold infant with Down syndrome has tachypnea, poor feeding, and failure to thrive. Exam: holosystolic murmur and mid‚Äëdiastolic rumble. ECG shows QRS axis ‚àí60¬∞, 1¬∞ AV block, and biventricular hypertrophy. CXR: marked cardiomegaly with increased pulmonary vascularity. Most likely diagnosis?",
    options: [
      "Large ventricular septal defect",
      "Complete atrioventricular septal defect",
      "Secundum atrial septal defect",
      "Patent ductus arteriosus",
      "Tetralogy of Fallot"
    ],
    answer_index: 1,
    explanation: "Superior leftward axis (‚àí30¬∞ to ‚àí90¬∞) with 1¬∞ AV block in an infant with trisomy 21 is virtually diagnostic of complete AVSD.",
    tags: ["Atrioventricular septal defect","Down syndrome","superior leftward axis","ECG"]
  },
  {
    id: 10,
    number: 10,
    module: "Module 3: Coarctation",
    topic: "Coarctation",
    stem: "A 14‚Äëyear‚Äëold has right arm BP 145/80 mm Hg and left leg 95/60 mm Hg. Femoral pulses are weak and delayed. CXR shows rib notching. Which additional cardiac lesion is most likely present?",
    options: [
      "Atrial septal defect",
      "Ventricular septal defect",
      "Bicuspid aortic valve",
      "Pulmonic stenosis",
      "Tricuspid regurgitation"
    ],
    answer_index: 2,
    explanation: "Coarctation of the aorta strongly associates with bicuspid aortic valve (‚âà50‚Äì85% of cases).",
    tags: ["Coarctation of the aorta","bicuspid aortic valve","rib notching","exam findings"]
  },
  {
    id: 11,
    number: 11,
    module: "Module 4: Tetralogy of Fallot",
    topic: "Tetralogy of Fallot",
    stem: "A 4‚Äëmonth‚Äëold with known tetralogy develops a hypercyanotic spell (severe cyanosis, irritability, hyperpnea). The previously audible systolic murmur becomes softer. Which initial maneuver is most appropriate?",
    options: [
      "Supine with legs extended",
      "Knee‚Äëchest position",
      "Supplemental oxygen by face mask",
      "Emergency intubation",
      "Intravenous fluid bolus"
    ],
    answer_index: 1,
    explanation: "Knee‚Äëchest increases systemic vascular resistance, reducing right‚Äëto‚Äëleft shunt across the VSD and improving pulmonary blood flow. Oxygen, morphine, and fluids are helpful but knee‚Äëchest is first.",
    tags: ["Tetralogy of Fallot","hypercyanotic spell","knee‚Äëchest position","acute management"]
  },
  {
    id: 12,
    number: 12,
    module: "Module 4: Transposition",
    topic: "Transposition",
    stem: "A newborn has central cyanosis at 6 hours of age. SaO‚ÇÇ 65% on room air ‚Üí 68% on 100% oxygen. CXR shows an egg‚Äëon‚Äëa‚Äëstring silhouette. Which intervention is most urgently needed?",
    options: [
      "Indomethacin infusion",
      "Prostaglandin E1 infusion",
      "Inhaled nitric oxide",
      "Mechanical ventilation",
      "Digoxin administration"
    ],
    answer_index: 1,
    explanation: "Transposition has parallel circulations; survival depends on mixing. Start PGE1 to open/maintain the ductus for mixing (and consider balloon atrial septostomy).",
    tags: ["Transposition of the great arteries","prostaglandin E1","ductal‚Äëdependent","egg‚Äëon‚Äëa‚Äëstring"]
  },
  {
    id: 13,
    number: 13,
    module: "Module 4: Truncus Arteriosus",
    topic: "Truncus Arteriosus",
    stem: "A 6‚Äëweek‚Äëold has tachypnea, diaphoresis with feeds, poor weight gain, mild cyanosis (SaO‚ÇÇ ‚âà80%), bounding pulses, single loud S2, and a systolic ejection murmur. CXR: marked cardiomegaly, widened mediastinum, and increased pulmonary vascular markings. Most likely diagnosis?",
    options: [
      "Tetralogy of Fallot",
      "Truncus arteriosus",
      "Transposition of the great arteries",
      "Total anomalous pulmonary venous return",
      "Tricuspid atresia"
    ],
    answer_index: 1,
    explanation: "Truncus ‚Üí complete mixing (mild cyanosis) with unobstructed high‚Äëpressure flow to PAs ‚Üí dramatic pulmonary overcirculation by 4‚Äì6 weeks (increased markings), single S2, bounding pulses.",
    tags: ["Truncus arteriosus","increased markings with cyanosis","CXR","image association"]
  },
  {
    id: 14,
    number: 14,
    module: "Module 4: TAPVR",
    topic: "Total Anomalous Pulmonary Venous Return",
    stem: "A 4‚Äëmonth‚Äëold with mild cyanosis and tachypnea has CXR snowman sign. Echo: all four pulmonary veins drain to a vertical vein ascending along the left mediastinum (supracardiac TAPVR). Which exam finding is expected?",
    options: [
      "Continuous machinery murmur",
      "Holosystolic murmur at the left lower sternal border",
      "Fixed split second heart sound",
      "Single second heart sound",
      "Loud pulmonic component of S2 (P2) as the primary finding"
    ],
    answer_index: 2,
    explanation: "Unobstructed TAPVR causes massive right heart volume overload ‚Üí systolic ejection murmur (increased PV flow), mid‚Äëdiastolic tricuspid rumble, and fixed wide splitting of S2‚Äîsimilar to ASD.",
    tags: ["TAPVR","snowman sign","fixed split S2","ASD‚Äëlike physiology"]
  },
  {
    id: 15,
    number: 15,
    module: "Module 5: Eisenmenger Syndrome",
    topic: "Eisenmenger Syndrome",
    stem: "A 28‚Äëyear‚Äëold with an unrepaired large VSD now has progressive exercise intolerance, cyanosis, and clubbing. P2 is loud; the previously audible holosystolic murmur is no longer present. Best explanation for the disappearance of the murmur?",
    options: [
      "Spontaneous closure of the ventricular septal defect",
      "Development of pulmonary vascular disease with shunt reversal",
      "Improvement in left ventricular function",
      "Development of right ventricular dysfunction",
      "Reduction in ventricular septal defect size"
    ],
    answer_index: 1,
    explanation: "Eisenmenger: PVR ‚â• SVR ‚Üí shunt reversal to right‚Äëto‚Äëleft. The LV‚ÄìRV pressure gradient disappears (or reverses), eliminating turbulent LV‚ÜíRV flow and the VSD murmur.",
    tags: ["Eisenmenger syndrome","VSD","shunt reversal","murmur disappearance","pulmonary vascular disease"]
  },
  {
    id: 16,
    number: 16,
    module: "Module 5: Hemodynamics",
    topic: "Hemodynamics",
    stem: "During auscultation, a sustained handgrip increases the intensity of a holosystolic murmur at the left lower sternal border. Which lesion most likely explains this murmur?",
    options: [
      "Atrial septal defect",
      "Ventricular septal defect",
      "Pulmonic stenosis",
      "Aortic stenosis",
      "Tetralogy of Fallot"
    ],
    answer_index: 1,
    explanation: "Handgrip ‚Üí ‚ÜëSVR and aortic pressure ‚Üí ‚ÜëLV‚ÜíRV gradient and left‚Äëto‚Äëright shunt across a VSD ‚Üí louder holosystolic murmur at the LLSB. Obstructive lesions typically soften with handgrip.",
    tags: ["Ventricular septal defect","handgrip","murmur characteristics","hemodynamics"]
  },
  {
    id: 17,
    number: 17,
    module: "Module 6: Electrocardiography",
    topic: "Electrocardiography",
    stem: "An ECG in a 5‚Äëyear‚Äëold with congenital heart disease shows QRS axis ‚àí70¬∞. Which lesion is most likely present?",
    options: [
      "Secundum atrial septal defect",
      "Primum atrial septal defect",
      "Ventricular septal defect",
      "Pulmonic stenosis",
      "Tetralogy of Fallot"
    ],
    answer_index: 1,
    explanation: "Marked left axis deviation (‚àí30¬∞ to ‚àí90¬∞) is highly specific for primum ASD/AVSD due to abnormal AV node position and conduction.",
    tags: ["Primum ASD","ECG","left axis deviation","fastest discriminator"]
  },
  {
    id: 18,
    number: 18,
    module: "Module 6: Chest Radiography",
    topic: "Chest Radiography",
    stem: "A chest radiograph of an adolescent with new hypertension shows scalloping of the inferior borders of the posterior ribs bilaterally. What best explains this finding?",
    options: [
      "Chronic intercostal muscle atrophy",
      "Enlarged intercostal arteries serving as collateral circulation",
      "Rib fractures from chest compressions",
      "Congenital skeletal dysplasia",
      "Metastatic bone lesions"
    ],
    answer_index: 1,
    explanation: "Rib notching in chronic coarctation is due to enlarged, tortuous intercostal collateral arteries eroding the inferior rib margins over years.",
    tags: ["Coarctation of the aorta","rib notching","collateral circulation","CXR"]
  },
  {
    id: 19,
    number: 19,
    module: "Module 6: Newborn Screening",
    topic: "Newborn Screening",
    stem: "Pulse oximetry screening at 26 hours shows right hand 97% and left foot 96%. What action is most appropriate?",
    options: [
      "Repeat screening in one hour",
      "Obtain immediate echocardiography",
      "Initiate prostaglandin E1 infusion",
      "Document as passing screen and discharge as planned",
      "Obtain arterial blood gas"
    ],
    answer_index: 3,
    explanation: "Passing criteria: ‚â•95% in either extremity and ‚â§3% absolute difference. However, note screening limitations for left‚Äësided obstructive lesions (e.g., coarctation).",
    tags: ["Newborn screening","CCHD screen","interpretation","public health"]
  },
  {
    id: 20,
    number: 20,
    module: "Module 7: Prostaglandin Management",
    topic: "Prostaglandin Management",
    stem: "A newborn with hypoplastic left heart syndrome is started on prostaglandin E1 at 36 hours of age. Which adverse effect should be most closely anticipated?",
    options: [
      "Hypertension",
      "Apnea",
      "Bradycardia",
      "Hyperglycemia",
      "Thrombocytosis"
    ],
    answer_index: 1,
    explanation: "Apnea occurs in ~10‚Äì20% with PGE1, particularly at higher doses and in preterm/low‚Äëbirth‚Äëweight infants. Intensive monitoring (and low threshold for intubation) is required.",
    tags: ["Prostaglandin E1","adverse effects","apnea","HLHS"]
  },
  {
    id: 21,
    number: 21,
    module: "Module 8: Genetics",
    topic: "Genetics",
    stem: "A newborn has a murmur, micrognathia, cleft palate, and low‚Äëset ears. Labs: hypocalcemia (Ca 6.5 mg/dL). Lymphocyte subsets show markedly reduced CD3+ T cells. Which genetic abnormality is most likely?",
    options: [
      "Trisomy 21",
      "45,X karyotype",
      "22q11.2 deletion",
      "7q11.23 deletion",
      "PTPN11 mutation"
    ],
    answer_index: 2,
    explanation: "22q11.2 deletion (DiGeorge/velocardiofacial) ‚Üí conotruncal defects, thymic hypoplasia (‚ÜìT cells), and hypocalcemia from hypoparathyroidism (CATCH‚Äë22).",
    tags: ["22q11.2 deletion","DiGeorge syndrome","hypocalcemia","T‚Äëcell immunodeficiency","conotruncal defects"]
  },
  {
    id: 22,
    number: 22,
    module: "Module 8: Maternal Factors",
    topic: "Maternal Factors",
    stem: "A pregnant woman with poorly controlled type 1 diabetes delivers at term. Which congenital heart defect is most strongly associated with maternal diabetes?",
    options: [
      "Ventricular septal defect",
      "Transposition of the great arteries",
      "Atrial septal defect",
      "Coarctation of the aorta",
      "Tetralogy of Fallot"
    ],
    answer_index: 1,
    explanation: "Maternal diabetes increases CHD risk; strongest association is with transposition of the great arteries. Hypertrophic cardiomyopathy of infancy is also characteristic.",
    tags: ["Maternal diabetes","transposition of great arteries","risk factors","teratology"]
  },
  {
    id: 23,
    number: 23,
    module: "Module 3: Confusables",
    topic: "Confusables",
    stem: "A 6‚Äëmonth‚Äëold with cyanosis and a boot‚Äëshaped heart with decreased pulmonary vascular markings on CXR. Which maneuver by the parents most likely improves oxygenation?",
    options: [
      "Placing the infant supine",
      "Encouraging the infant to stand",
      "Holding the infant with hips and knees flexed",
      "Laying the infant prone",
      "Having the infant lie on the right side"
    ],
    answer_index: 2,
    explanation: "Tetralogy of Fallot: knee‚Äëchest (squatting physiology) ‚Üí ‚ÜëSVR ‚Üí ‚Üìright‚Äëto‚Äëleft shunt ‚Üí ‚Üëpulmonary blood flow and oxygenation.",
    tags: ["Tetralogy of Fallot","squatting","knee‚Äëchest","hemodynamics","parent counseling"]
  },
  {
    id: 24,
    number: 24,
    module: "Module 4: Image Association",
    topic: "Image Association",
    stem: "A cyanotic newborn‚Äôs CXR shows an ovoid cardiac silhouette with a narrow superior mediastinum (egg‚Äëon‚Äëa‚Äëstring). Which additional finding is most characteristic of this condition?",
    options: [
      "Increased pulmonary vascular markings",
      "Boot‚Äëshaped heart",
      "Rib notching",
      "Snowman sign",
      "Figure‚Äëthree sign"
    ],
    answer_index: 0,
    explanation: "Egg‚Äëon‚Äëa‚Äëstring is pathognomonic for transposition. Pulmonary markings are often normal or increased, especially if a large VSD is present.",
    tags: ["Transposition of great arteries","egg‚Äëon‚Äëa‚Äëstring","CXR","image association"]
  },
  {
    id: 25,
    number: 25,
    module: "Module 1: Embryology Map",
    topic: "Embryology",
    stem: "Neural crest cells migrate into the cardiac outflow tract (weeks 5‚Äì7) to form the aorticopulmonary septum. Deficiency of neural crest migration predisposes to which group of defects?",
    options: [
      "Atrial septal defects",
      "Muscular ventricular septal defects",
      "Conotruncal defects",
      "Atrioventricular valve abnormalities",
      "Coronary artery anomalies"
    ],
    answer_index: 2,
    explanation: "Neural crest dysfunction ‚Üí conotruncal defects: persistent truncus arteriosus, tetralogy of Fallot, transposition (failure to spiral), interrupted aortic arch. Strong association with 22q11.2 deletion (TBX1).",
    tags: ["Neural crest cells","conotruncal defects","embryology","22q11.2"]
  },
  {
    id: 26,
    number: 26,
    module: "Module 5: Eisenmenger Differential",
    topic: "Eisenmenger Differential",
    stem: "A 19‚Äëyear‚Äëold with an unrepaired patent ductus arteriosus presents with exercise intolerance and fatigue. Exam: cyanosis and clubbing of the toes; hands are pink with normal upper‚Äëextremity SaO‚ÇÇ. Best explanation?",
    options: [
      "The ductus arteriosus has spontaneously closed",
      "Pulmonary vascular resistance now exceeds systemic vascular resistance",
      "Left ventricular function has deteriorated",
      "Pulmonary embolism has developed",
      "Bacterial endocarditis has developed"
    ],
    answer_index: 1,
    explanation: "PDA with Eisenmenger produces differential cyanosis because the ductus enters the descending aorta distal to the left subclavian; R‚ÜíL flow perfuses only the lower body when PVR ‚â• SVR.",
    tags: ["Patent ductus arteriosus","Eisenmenger","differential cyanosis","pathognomonic finding"]
  },
  {
    id: 27,
    number: 27,
    module: "Module 6: ECG Axis Confusables",
    topic: "ECG Axis",
    stem: "An infant with congenital heart disease and trisomy 21 has ECG: QRS axis ‚àí50¬∞, 1¬∞ AV block, and biventricular hypertrophy. Most likely diagnosis?",
    options: [
      "Secundum atrial septal defect",
      "Complete atrioventricular septal defect",
      "Ventricular septal defect",
      "Tetralogy of Fallot",
      "Patent ductus arteriosus"
    ],
    answer_index: 1,
    explanation: "Superior leftward axis with 1¬∞ AV block is virtually diagnostic of AVSD (complete), especially in Down syndrome.",
    tags: ["Atrioventricular septal defect","superior leftward axis","ECG","Down syndrome"]
  },
  {
    id: 28,
    number: 28,
    module: "Module 7: Oxygen Management",
    topic: "Critical Care Physiology",
    stem: "A neonate with hypoplastic left heart syndrome is stabilized on prostaglandin E1. Which ventilatory strategy best balances pulmonary and systemic blood flow?",
    options: [
      "Maximal FiO‚ÇÇ to keep saturations >95%",
      "Hyperventilation to reduce PaCO‚ÇÇ <30 mm Hg",
      "Controlled hypoventilation with modest hypercapnia and limited inspired oxygen",
      "Positive end‚Äëexpiratory pressure of 15 cm H‚ÇÇO",
      "High tidal volumes on mechanical ventilation"
    ],
    answer_index: 2,
    explanation: "In single‚Äëventricle physiology supplying both circuits, avoid excessive pulmonary vasodilation. Use limited FiO‚ÇÇ and modest hypercapnia to keep PVR up enough to preserve systemic perfusion (target SaO‚ÇÇ often 75‚Äì85%).",
    tags: ["HLHS","oxygen management","pulmonary vascular resistance","ventilation strategy"]
  },
  {
    id: 29,
    number: 29,
    module: "Module 8: Teratogen Association",
    topic: "Teratology",
    stem: "A pregnant woman is treated with isotretinoin for severe acne and becomes pregnant. If the pregnancy continues, which congenital heart defect is most characteristic?",
    options: [
      "Atrial septal defect",
      "Truncus arteriosus",
      "Ebstein anomaly",
      "Bicuspid aortic valve",
      "Atrioventricular septal defect"
    ],
    answer_index: 1,
    explanation: "Retinoic acid embryopathy ‚Üí conotruncal/aortic arch defects (truncus, transposition, TOF, interrupted arch, DORV). Isotretinoin is contraindicated in pregnancy (iPLEDGE).",
    tags: ["Isotretinoin","retinoic acid","teratology","conotruncal defects"]
  },
  {
    id: 30,
    number: 30,
    module: "Module 2: Fetal Shunts",
    topic: "Fetal Physiology",
    stem: "During fetal life, which structure allows oxygenated blood returning from the umbilical vein to bypass hepatic circulation and enter the inferior vena cava directly?",
    options: [
      "Foramen ovale",
      "Ductus arteriosus",
      "Ductus venosus",
      "Ligamentum teres",
      "Portal vein"
    ],
    answer_index: 2,
    explanation: "The ductus venosus shunts ~50% of umbilical venous blood directly to the IVC, bypassing the liver; later becomes the ligamentum venosum.",
    tags: ["Fetal circulation","ductus venosus","umbilical vein","fetal shunts","embryology"]
  },
  {
    id: 31,
    number: 31,
    module: "Module 3: Patent Ductus Arteriosus",
    topic: "Patent Ductus Arteriosus",
    stem: "A 4‚Äëmonth‚Äëold with a continuous murmur has CXR cardiomegaly, increased pulmonary markings, and a prominent ascending aorta. Which physical finding is most characteristic?",
    options: [
      "Differential cyanosis of lower extremities",
      "Wide pulse pressure with bounding pulses",
      "Weak femoral pulses",
      "Fixed splitting of the second heart sound",
      "Pulsus paradoxus"
    ],
    answer_index: 1,
    explanation: "PDA with significant left‚Äëto‚Äëright shunt ‚Üí diastolic runoff ‚Üí wide pulse pressure and bounding (water‚Äëhammer) pulses.",
    tags: ["Patent ductus arteriosus","wide pulse pressure","bounding pulses","hemodynamics"]
  },
  {
    id: 32,
    number: 32,
    module: "Module 4: Cyanotic Confusables",
    topic: "Confusables",
    stem: "Two neonates present cyanotic at birth. Patient A: boot‚Äëshaped heart with decreased pulmonary vascular markings. Patient B: egg‚Äëon‚Äëa‚Äëstring with narrow mediastinum. Which best distinguishes the underlying physiology?",
    options: [
      "A has increased pulmonary flow; B has decreased flow",
      "A has obstruction to pulmonary outflow; B has parallel circulations",
      "Both have right‚Äëto‚Äëleft shunting at the ventricular level",
      "A requires prostaglandin; B does not",
      "Both have single‚Äëventricle physiology"
    ],
    answer_index: 1,
    explanation: "A = TOF ‚Üí RVOT obstruction drives R‚ÜíL shunt across VSD (‚Üìpulmonary flow). B = TGA ‚Üí parallel systemic/pulmonary circuits; survival depends on mixing.",
    tags: ["Tetralogy of Fallot","transposition","confusables","physiology comparison","fastest discriminator"]
  },
  {
    id: 33,
    number: 33,
    module: "Module 6: Newborn Screening Limitations",
    topic: "Newborn Screening",
    stem: "A newborn passes pulse‚Äëox screening at 24 hours (97% right hand, 96% foot) and is discharged. At day 3, the infant presents with poor feeding, lethargy, and absent femoral pulses. Why was this not detected by screening?",
    options: [
      "The screening was performed too early",
      "The infant has a left‚Äësided obstructive lesion without significant hypoxemia",
      "The pulse oximeter was not calibrated correctly",
      "The infant developed an acquired cardiac condition after birth",
      "Pre‚Äëductal and post‚Äëductal saturations should have been measured in both arms"
    ],
    answer_index: 1,
    explanation: "Coarctation and other left‚Äësided obstructive lesions may have normal oxygen saturations (no cyanosis) yet crash when the ductus closes‚Äîthus pulse‚Äëox screening can miss them.",
    tags: ["Newborn screening","coarctation","false negative","limitations"]
  },
  {
    id: 34,
    number: 34,
    module: "Module 8: Williams Syndrome",
    topic: "Genetics",
    stem: "A 4‚Äëyear‚Äëold with developmental delay and an overly friendly personality has a systolic ejection murmur at the right upper sternal border. BP is higher in the right arm (120/70) than the left (95/60). Most likely genetic abnormality?",
    options: [
      "Trisomy 21",
      "22q11.2 deletion",
      "7q11.23 deletion",
      "45,X karyotype",
      "PTPN11 mutation"
    ],
    answer_index: 2,
    explanation: "Williams syndrome (7q11.23 deletion including elastin): supravalvar aortic stenosis (CoandƒÉ effect ‚Üí higher right arm pressure), elfin facies, social personality, sometimes infantile hypercalcemia.",
    tags: ["Williams syndrome","7q11.23 deletion","supravalvar aortic stenosis","CoandƒÉ effect","genetics"]
  },
  {
    id: 35,
    number: 35,
    module: "Module 3: VSD Natural History",
    topic: "Ventricular Septal Defect",
    stem: "A 6‚Äëmonth‚Äëold with a small muscular VSD (loud holosystolic murmur at LLSB) is asymptomatic. At age 2, the murmur is no longer audible. Best explanation?",
    options: [
      "The defect enlarged, equalizing ventricular pressures",
      "The infant developed Eisenmenger syndrome",
      "The defect closed spontaneously as the muscular septum grew",
      "Left ventricular function has deteriorated",
      "The infant developed pulmonary hypertension"
    ],
    answer_index: 2,
    explanation: "Small muscular VSDs close spontaneously in ~50‚Äì70% by age 2‚Äì3 as the muscular septum thickens; murmurs may intensify as the orifice narrows before closure.",
    tags: ["VSD","spontaneous closure","natural history","muscular VSD"]
  },
  {
    id: 36,
    number: 36,
    module: "Module 4: Ebstein Anomaly",
    topic: "Ebstein Anomaly",
    stem: "A newborn with massive cardiomegaly (box‚Äëshaped heart) has tall broad P waves, prolonged PR, and low‚Äëamplitude QRS complexes. The mother has bipolar disorder. Which medication exposure most likely contributed?",
    options: [
      "Valproic acid",
      "Lithium",
      "Carbamazepine",
      "Lamotrigine",
      "Selective serotonin reuptake inhibitor"
    ],
    answer_index: 1,
    explanation: "Maternal lithium use in the first trimester increases risk of Ebstein anomaly (malformed, apically displaced tricuspid valve).",
    tags: ["Ebstein anomaly","maternal lithium","teratology","ECG","neonatal cyanosis"]
  },
  {
    id: 37,
    number: 37,
    module: "Module 5: Maneuvers",
    topic: "Hemodynamics",
    stem: "A child with tetralogy of Fallot frequently squats after play. Which hemodynamic change during squatting improves symptoms?",
    options: [
      "Decreased systemic vascular resistance",
      "Increased pulmonary vascular resistance",
      "Increased right‚Äëto‚Äëleft shunt across the VSD",
      "Increased systemic vascular resistance",
      "Decreased venous return"
    ],
    answer_index: 3,
    explanation: "Squatting ‚Üí ‚ÜëSVR and venous return ‚Üí ‚ÜìR‚ÜíL shunt across VSD ‚Üí ‚Üëpulmonary blood flow ‚Üí better oxygenation.",
    tags: ["Tetralogy of Fallot","squatting","systemic vascular resistance","hemodynamics"]
  },
  {
    id: 38,
    number: 38,
    module: "Module 1: TAPVR vs PAPVR",
    topic: "Confusables",
    stem: "Distinguishing TAPVR from PAPVR: which feature is characteristic of total anomalous pulmonary venous return but not partial anomalous pulmonary venous return?",
    options: [
      "Fixed splitting of the second heart sound",
      "Obligatory right‚Äëto‚Äëleft shunt at the atrial level with cyanosis",
      "Increased pulmonary vascular markings on CXR",
      "Right ventricular volume overload",
      "Association with sinus venosus atrial septal defect"
    ],
    answer_index: 1,
    explanation: "TAPVR: all pulmonary venous blood returns to the right heart ‚Üí must cross an ASD/PFO to reach the left heart ‚Üí obligatory R‚ÜíL shunt with cyanosis. PAPVR preserves some normal drainage, so no obligatory cyanosis.",
    tags: ["TAPVR","PAPVR","confusables","obligatory shunt","cyanosis"]
  },
  {
    id: 39,
    number: 39,
    module: "Module 4: Truncus vs TOF",
    topic: "Confusables",
    stem: "A 6‚Äëweek‚Äëold with mild cyanosis and CHF has single loud S2, bounding pulses, and CXR with marked cardiomegaly and greatly increased pulmonary vascular markings. Which echo finding best fits?",
    options: [
      "Large VSD with overriding aorta and RVOT obstruction",
      "Single arterial trunk with pulmonary arteries branching from the trunk",
      "Aorta from right ventricle and pulmonary artery from left ventricle",
      "Absent tricuspid valve with hypoplastic right ventricle",
      "All four pulmonary veins draining to the right atrium"
    ],
    answer_index: 1,
    explanation: "Truncus arteriosus: single arterial trunk overriding a VSD; unobstructed pulmonary blood flow at systemic pressure ‚Üí increased markings, CHF by 4‚Äì6 weeks.",
    tags: ["Truncus arteriosus","CXR increased markings","confusables","echo"]
  },
  {
    id: 40,
    number: 40,
    module: "Module 7: PGE1 Indications",
    topic: "Emergency Management",
    stem: "A neonate at 18 hours develops shock, absent femoral pulses, and severe metabolic acidosis (lactate 12 mmol/L). Right arm BP 85/60; leg BP unobtainable. Most appropriate immediate intervention?",
    options: [
      "Indomethacin infusion",
      "Prostaglandin E1 infusion",
      "Furosemide administration",
      "Digoxin administration",
      "Immediate surgical consultation before stabilization"
    ],
    answer_index: 1,
    explanation: "Ductal‚Äëdependent systemic circulation (e.g., severe coarctation or HLHS) crashing as the duct closes ‚Üí start PGE1 immediately to restore systemic perfusion; then define anatomy and plan repair.",
    tags: ["Prostaglandin E1","ductal‚Äëdependent lesion","coarctation","shock","emergency management"]
  }
];

// Copy into QUESTIONS (so the rest of the script uses the same name)
const QUESTIONS = FULL_QUESTIONS;
</script>

<script>
// ---------- CONTENT SIGNATURE / STORAGE KEYS ----------
const CONTENT_SIG = QUESTIONS.length + ":" + QUESTIONS.reduce((s,q)=> s + q.id + (q.answer_index||0), 0);
const STORAGE_KEY = "ms2_qbank_progress_" + CONTENT_SIG;
const THEME_KEY = "ms2_qbank_theme";

// ---------- STATE ----------
let state = {
  mode: "practice", // or "exam"
  filteredIds: [],
  index: 0,
  selectedIndex: null,
  answered: false,
  showExplanation: false,
  examAnswers: {},  // id -> selectedIndex
  examStarted: false
};
const Q_BY_ID = new Map(QUESTIONS.map(q => [q.id, q]));
let progress = loadProgress();

// Exam timer
let examTimerId = null;
let examStartTs = 0;

// ---------- UTIL ----------
function shuffle(arr){ // Fisher-Yates
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}
function byId(id){return document.getElementById(id)}
function getCurrentQuestion(){
  const id = state.filteredIds[state.index];
  return Q_BY_ID.get(id);
}
function unique(arr){return Array.from(new Set(arr))}
function clamp(n,min,max){return Math.max(min, Math.min(max, n))}
function letters(i){return String.fromCharCode(65+i)}
function percent(x, y){return y ? Math.round((x/y)*100) : 0}
function fmtTime(ms){ const s=Math.floor(ms/1000); const m=Math.floor(s/60); const ss=s%60; return String(m).padStart(2,"0")+":"+String(ss).padStart(2,"0"); }
function showToast(msg){
  const t = byId("toast");
  t.textContent = msg;
  t.classList.add("show");
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=> t.classList.remove("show"), 1600);
}
function debounce(fn, ms=150){
  let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); };
}
function startExamTimer(){
  if(examTimerId) return;
  examStartTs = Date.now();
  byId("timerPill").classList.remove("hidden");
  byId("timerPill").textContent = "‚è± 00:00";
  examTimerId = setInterval(()=>{
    byId("timerPill").textContent = "‚è± " + fmtTime(Date.now()-examStartTs);
  }, 1000);
}
function stopExamTimer(){
  if(examTimerId){ clearInterval(examTimerId); examTimerId = null; }
}

// ---------- STORAGE ----------
function loadProgress(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return { attempts:{}, session:null };
    const obj = JSON.parse(raw);
    if(!obj.attempts) obj.attempts = {};
    return obj;
  }catch(e){
    return { attempts:{}, session:null };
  }
}
function saveProgress(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(progress));
}
function saveSession(){
  progress.session = { filteredIds: state.filteredIds, index: state.index };
  saveProgress();
}

// ---------- FILTERS UI ----------
function initFilters(){
  // Modules
  const modules = unique(QUESTIONS.map(q=>q.module));
  const modDiv = byId("moduleFilters");
  modDiv.innerHTML = "";
  modules.forEach((m, idx)=>{
    const id = "mod_"+idx;
    const wrap = document.createElement("label");
    wrap.innerHTML = `<input type="checkbox" id="${id}" checked> ${m}`;
    modDiv.appendChild(wrap);
  });

  // Tags
  const tags = unique(QUESTIONS.flatMap(q=>q.tags||[])).sort((a,b)=>a.localeCompare(b));
  const tagWrap = byId("tagChips");
  tagWrap.innerHTML = "";
  tags.forEach(t=>{
    const chip = document.createElement("div");
    chip.className = "chip";
    chip.textContent = t;
    chip.dataset.tag = t;
    chip.onclick = ()=> chip.classList.toggle("active");
    tagWrap.appendChild(chip);
  });
}

function activeFilters(){
  // Modules
  const modules = Array.from(byId("moduleFilters").querySelectorAll("input[type=checkbox]"))
    .filter(cb=>cb.checked)
    .map((cb)=>cb.parentElement.textContent.trim());
  const tagChips = Array.from(document.querySelectorAll("#tagChips .chip.active")).map(el=>el.dataset.tag);
  const onlyUnseen = byId("onlyUnseen").checked;
  const onlyFlagged = byId("onlyFlagged").checked;
  const query = byId("searchBox").value.trim().toLowerCase();

  let ids = QUESTIONS
    .filter(q=>modules.includes(q.module))
    .filter(q=>tagChips.length===0 || (q.tags||[]).some(t=>tagChips.includes(t)))
    .filter(q=>!onlyUnseen || !progress.attempts[q.id])
    .filter(q=>!onlyFlagged || (progress.attempts[q.id] && progress.attempts[q.id].flagged))
    .filter(q=>!query || (q.stem.toLowerCase().includes(query) ||
                          (q.tags||[]).some(t=>t.toLowerCase().includes(query)) ||
                          q.module.toLowerCase().includes(query)))
    .map(q=>q.id);

  return ids;
}

// ---------- RENDER QUESTION ----------
function render(){
  // Stats header
  const seen = Object.keys(progress.attempts).length;
  const correct = Object.values(progress.attempts).reduce((s,a)=> s + (a.correct||0), 0);
  const attempts = Object.values(progress.attempts).reduce((s,a)=> s + (a.attempts||0), 0);
  byId("seenCount").textContent = seen;
  const acc = attempts ? Math.round((correct/attempts)*100) : 0;
  byId("accPct").textContent = attempts ? acc + "%" : "‚Äî";
  byId("accBar").style.width = acc + "%";

  // Filter‚Äëset stats (live subset)
  renderFilterStats();

  // Session counter
  byId("qCounter").textContent = (state.index+1) + " / " + state.filteredIds.length;

  const q = getCurrentQuestion();
  if(!q){ return; }
  byId("qModule").textContent = q.module;
  byId("qStem").textContent = q.stem;

  // Build semantic radio options
  const opts = byId("options");
  opts.innerHTML = "";
  opts.setAttribute("role","radiogroup");
  opts.setAttribute("aria-label","Answer choices");
  q.options.forEach((optText, i)=>{
    const label = document.createElement("label");
    label.className = "option";
    label.tabIndex = 0;

    const input = document.createElement("input");
    input.type = "radio";
    input.name = "choice";
    input.value = i;
    input.className = "visually-hidden";
    input.onchange = () => selectOption(i);

    const letter = document.createElement("div");
    letter.className = "letter";
    letter.textContent = letters(i);

    const text = document.createElement("div");
    text.className = "text";
    text.textContent = optText;

    // Click on the label selects the option
    label.onclick = (e)=>{ if(e.target!==input){ input.checked = true; selectOption(i); } };
    label.onkeydown = (e)=>{ if(e.key==="Enter" || e.key===" "){ e.preventDefault(); input.checked=true; selectOption(i); } };

    label.append(input, letter, text);
    opts.appendChild(label);
  });

  // Reset controls & explanation (safe)
  byId("correctness").textContent = "";
  const ex = byId("explain");
  ex.classList.remove("show");
  ex.replaceChildren();
  const strong = document.createElement("strong");
  strong.textContent = "Explanation. ";
  ex.append(strong, document.createTextNode(q.explanation));
  const tagWrap = byId("tagList");
  tagWrap.replaceChildren();
  (q.tags||[]).forEach(t=>{
    const span = document.createElement("span");
    span.className = "tag"; span.textContent = t;
    tagWrap.appendChild(span);
  });

  // ‚úÖ Logic fix: enable Submit in EXAM, disable in PRACTICE; disable explanation in EXAM
  byId("submitBtn").disabled = (state.mode === "practice");
  byId("showExplainBtn").disabled = (state.mode === "exam");
  byId("showExplainBtn").setAttribute("aria-expanded", "false");

  // Exam navigation polish
  byId("prevBtn").disabled = (state.mode === "exam"); // no backtracking in exam
  byId("nextBtn").disabled = (state.mode === "exam" && state.selectedIndex == null);

  state.selectedIndex = null;
  state.answered = false;
  state.showExplanation = false;

  // Flag state
  const flagged = progress.attempts[q.id]?.flagged;
  byId("flagBtn").textContent = flagged ? "‚öë Flagged" : "‚öë Flag";
  byId("flagBtn").style.borderColor = flagged ? "var(--warn)" : "var(--border)";
  byId("flagBtn").style.background = flagged ? "#2a2310" : "var(--chip)";
  byId("flagBtn").setAttribute("aria-pressed", flagged ? "true" : "false");

  saveSession();
}

function selectOption(i){
  if(state.answered && state.mode==="practice"){ return; }
  state.selectedIndex = i;
  const optionDivs = Array.from(document.querySelectorAll(".option"));
  optionDivs.forEach(div=>div.classList.remove("selected"));
  optionDivs[i].classList.add("selected");

  // In exam, just select; in practice, auto-check immediately
  if(state.mode==="practice"){
    checkAnswer();
  }else{
    // enable "Next" once a choice is made in exam
    byId("nextBtn").disabled = false;
  }
}

function checkAnswer(){
  if(state.selectedIndex == null) return;
  const q = getCurrentQuestion();
  const correct = (state.selectedIndex === q.answer_index);

  // Mark UI
  const optionDivs = Array.from(document.querySelectorAll(".option"));
  optionDivs.forEach((div, i)=>{
    div.classList.remove("selected");
    if(i === q.answer_index) div.classList.add("correct");
    if(i === state.selectedIndex && !correct) div.classList.add("incorrect");
  });

  // Feedback (live region)
  byId("correctness").textContent = correct ? "‚úÖ Correct" : `‚ùå Incorrect ‚Äî Answer: ${letters(q.answer_index)}. ${q.options[q.answer_index]}`;

  // Save progress (+ distractor tracking)
  const rec = progress.attempts[q.id] || { attempts:0, correct:0, lastAnswerIndex:null, flagged:false, distractors:[] };
  rec.attempts += 1;
  if(correct) rec.correct += 1;
  rec.lastAnswerIndex = state.selectedIndex;
  rec.lastSeen = new Date().toISOString();
  if(!correct){
    if(!Array.isArray(rec.distractors)) rec.distractors = [];
    rec.distractors[state.selectedIndex] = (rec.distractors[state.selectedIndex]||0) + 1;
  }
  progress.attempts[q.id] = rec;
  saveProgress();

  state.answered = true;

  // Auto-show explanation in practice based on preference
  if(AUTO_EXPLAIN_WRONG_ONLY ? !correct : true){
    toggleExplanation(true);
  }

  // If there is a clear "top distractor", append a hint
  const top = getTopDistractor(rec);
  if(top != null && (rec.attempts >= 2)){
    const hint = document.createElement("div");
    hint.className = "small";
    hint.textContent = `Common miss: ${letters(top)} ‚Äî consider why it‚Äôs tempting vs. the correct answer.`;
    byId("explain").appendChild(hint);
  }
}

function getTopDistractor(rec){
  if(!rec || !Array.isArray(rec.distractors)) return null;
  let bestIdx = null, bestVal = 0;
  rec.distractors.forEach((v,i)=>{ if((v||0) > bestVal){ bestVal = v; bestIdx = i; }});
  return (bestVal>0) ? bestIdx : null;
}

function submitExamAnswer(){
  if(state.selectedIndex == null){ showToast("Select an answer first"); return; }

  // Start timer on first answer submission
  if(!state.examStarted){
    startExamTimer();
    state.examStarted = true;
  }

  const q = getCurrentQuestion();
  state.examAnswers[q.id] = state.selectedIndex;

  // Move forward; summary appears automatically at end
  const isLast = (state.index === state.filteredIds.length - 1);
  if(isLast){
    showExamSummary();
  }else{
    state.index = clamp(state.index + 1, 0, state.filteredIds.length - 1);
    saveSession();
    render();
  }
}

function showExamSummary(){
  // Stop timer and compute elapsed time
  stopExamTimer();
  const elapsedMs = examStartTs ? (Date.now() - examStartTs) : 0;
  byId("timerPill").textContent = "‚è± " + fmtTime(elapsedMs); // freeze display

  // Grade + update progress (including distractors)
  let correctCount = 0;
  state.filteredIds.forEach((id)=>{
    const q = Q_BY_ID.get(id);
    const sel = state.examAnswers[id];
    const ok = sel === q.answer_index;
    if(ok) correctCount++;

    const rec = progress.attempts[q.id] || { attempts:0, correct:0, flagged:false, distractors:[] };
    rec.attempts = (rec.attempts||0) + 1;
    rec.correct  = (rec.correct||0) + (ok?1:0);
    rec.lastAnswerIndex = sel;
    rec.lastSeen = new Date().toISOString();
    if(!ok){
      if(!Array.isArray(rec.distractors)) rec.distractors = [];
      rec.distractors[sel] = (rec.distractors[sel]||0) + 1;
    }
    progress.attempts[q.id] = rec;
  });
  saveProgress();

  const total = state.filteredIds.length;
  const pct = percent(correctCount, total);

  // Stats
  const stats = byId("examStats");
  stats.replaceChildren();
  const statDiv = document.createElement("div"); statDiv.className = "stat";
  statDiv.innerHTML = `
    <div class="kpi"><div class="small">Score</div><div style="font-weight:700; font-size:24px">${correctCount} / ${total} (${pct}%)</div></div>
    <div class="kpi"><div class="small">Mode</div><div style="font-weight:700; font-size:24px">Exam</div></div>
    <div class="kpi"><div class="small">Time</div><div style="font-weight:700; font-size:24px">${fmtTime(elapsedMs)}</div></div>
  `;
  stats.appendChild(statDiv);

  // Breakdown by module
  const byModule = {};
  state.filteredIds.forEach(id=>{
    const q = Q_BY_ID.get(id);
    const sel = state.examAnswers[id];
    const ok = sel === q.answer_index;
    if(!byModule[q.module]) byModule[q.module]={total:0, correct:0};
    byModule[q.module].total++;
    if(ok) byModule[q.module].correct++;
  });

  const breakdown = byId("breakdown");
  breakdown.replaceChildren();
  const h3a = document.createElement("h3"); h3a.textContent = "Breakdown";
  breakdown.appendChild(h3a);
  Object.entries(byModule).forEach(([m,stats])=>{
    const p = percent(stats.correct, stats.total);
    const d = document.createElement("div");
    d.className = "small";
    d.style.margin = "6px 0";
    d.innerHTML = `<strong>${m}:</strong> ${stats.correct}/${stats.total} (${p}%)`;
    breakdown.appendChild(d);
  });

  // Incorrect list (safe DOM; avoid injecting raw HTML)
  const h3b = document.createElement("h3"); h3b.textContent = "Review incorrect";
  breakdown.appendChild(h3b);
  const wrong = state.filteredIds.filter(id=> state.examAnswers[id] !== Q_BY_ID.get(id).answer_index );
  if(wrong.length===0){
    const msg = document.createElement("div"); msg.className="small"; msg.textContent="üéâ No misses ‚Äî well done!";
    breakdown.appendChild(msg);
  }else{
    wrong.forEach((id)=>{
      const q = Q_BY_ID.get(id);
      const sel = state.examAnswers[id];

      const det = document.createElement("details");
      det.style.cssText = "margin:8px 0; border:1px solid var(--border); border-radius:10px; padding:8px";

      const sum = document.createElement("summary");
      const strong = document.createElement("strong");
      strong.textContent = `Q${q.number}.`;
      sum.appendChild(strong);
      sum.appendChild(document.createTextNode(" " + q.stem.substring(0,80) + "‚Ä¶ "));
      const sumSpan = document.createElement("span"); sumSpan.className="small";
      sumSpan.textContent = `Your answer: ${letters(sel)} ‚Äî Correct: ${letters(q.answer_index)}`;
      sum.appendChild(sumSpan);

      const correctLine = document.createElement("div");
      correctLine.style.marginTop = "6px";
      const em = document.createElement("em"); em.textContent = "Correct:";
      correctLine.appendChild(em);
      correctLine.appendChild(document.createTextNode(` ${letters(q.answer_index)}. ${q.options[q.answer_index]}`));

      const ex = document.createElement("div");
      ex.style.marginTop="6px";
      const exStrong = document.createElement("strong"); exStrong.textContent = "Explanation. ";
      ex.append(exStrong, document.createTextNode(q.explanation));

      const tagDiv = document.createElement("div"); tagDiv.className = "tags"; tagDiv.style.marginTop="6px";
      (q.tags||[]).forEach(t=>{ const s=document.createElement("span"); s.className="tag"; s.textContent=t; tagDiv.appendChild(s); });

      det.append(sum, correctLine, ex, tagDiv);
      breakdown.appendChild(det);
    });
  }

  // Show summary
  byId("examSummary").classList.remove("hidden");
}

// ---------- EXPLANATION ----------
function toggleExplanation(forceShow=false){
  const x = byId("explain");
  const btn = byId("showExplainBtn");
  if(forceShow){ x.classList.add("show"); btn.setAttribute("aria-expanded","true"); return; }
  const willShow = !x.classList.contains("show");
  x.classList.toggle("show");
  btn.setAttribute("aria-expanded", willShow ? "true" : "false");
}

// ---------- SESSION ----------
function startSession(fromWrong=false){
  let ids;
  if(fromWrong){
    // Use "last attempt wrong" semantics
    ids = QUESTIONS.filter(q=>{
      const rec = progress.attempts[q.id];
      return rec && typeof rec.lastAnswerIndex === "number" && rec.lastAnswerIndex !== q.answer_index;
    }).map(q=>q.id);
  }else{
    ids = activeFilters();
  }

  if(ids.length===0){
    showToast("No questions match your filters.");
    return;
  }
  state.filteredIds = ids.slice();
  state.index = 0;
  state.selectedIndex = null;
  state.answered = false;
  state.examAnswers = {};
  state.examStarted = false;
  byId("examSummary").classList.add("hidden");

  // reset & hide timer on any new session
  stopExamTimer();
  byId("timerPill").classList.add("hidden");

  saveSession();
  render();
}

function nextQuestion(){
  // Exam: use Submit/Next flow; guard skip
  if(state.mode==="exam"){
    if(state.selectedIndex==null){ showToast("Select an answer first"); return; }
    submitExamAnswer();
    return;
  }
  state.index = clamp(state.index + 1, 0, state.filteredIds.length-1);
  saveSession();
  render();
}
function prevQuestion(){
  if(state.mode==="exam"){ showToast("Back is disabled in Exam"); return; }
  state.index = clamp(state.index - 1, 0, state.filteredIds.length-1);
  saveSession();
  render();
}

// ---------- FLAG ----------
function toggleFlag(){
  const q = getCurrentQuestion();
  const rec = progress.attempts[q.id] || { attempts:0, correct:0, lastAnswerIndex:null, flagged:false, distractors:[] };
  rec.flagged = !rec.flagged;
  progress.attempts[q.id] = rec;
  saveProgress();
  render();
}

// ---------- EXPORT/IMPORT ----------
function exportProgress(){
  const blob = new Blob([JSON.stringify(progress, null, 2)], {type: "application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "ms2-qbank-progress.json";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
function importProgress(){
  const inp = document.createElement("input");
  inp.type = "file"; inp.accept = "application/json";
  inp.onchange = ()=>{
    const file = inp.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const data = JSON.parse(reader.result);
        // Basic validation + size cap
        if(!data || typeof data!=="object" || !data.attempts || typeof data.attempts!=="object") throw new Error("Invalid file");
        if(Object.keys(data.attempts).length > 2000) throw new Error("Too large");
        progress = { attempts: data.attempts, session: data.session || null };
        saveProgress();
        showToast("Progress imported.");
        // Try to restore session if present; else just re-render
        if(progress.session && Array.isArray(progress.session.filteredIds)){
          state.filteredIds = progress.session.filteredIds.filter(id => Q_BY_ID.has(id));
          state.index = clamp(progress.session.index||0, 0, Math.max(0, state.filteredIds.length-1));
        }
        render();
      }catch(e){
        showToast("Could not import: " + e.message);
      }
    };
    reader.readAsText(file);
  };
  inp.click();
}
function resetProgress(){
  if(!confirm("Clear all saved progress?")) return;
  progress = { attempts:{}, session:null };
  saveProgress();
  render();
}

// ---------- FILTER STATS (live subset) ----------
function renderFilterStats(){
  const el = byId("filterStats");
  if(!state.filteredIds || state.filteredIds.length===0){ el.textContent=""; return; }
  // Per‚Äëmodule quick accuracy on current subset
  const byModule = {};
  state.filteredIds.forEach(id=>{
    const q = Q_BY_ID.get(id);
    const rec = progress.attempts[id];
    if(!byModule[q.module]) byModule[q.module] = {attempts:0, correct:0};
    if(rec){ byModule[q.module].attempts += rec.attempts||0; byModule[q.module].correct += rec.correct||0; }
  });
  const parts = Object.entries(byModule).map(([m,s])=>{
    const p = s.attempts? percent(s.correct, s.attempts) : "‚Äî";
    return `${m.split(":")[0]}: ${s.attempts? p+"%": "‚Äî"}`;
  });
  el.textContent = parts.join(" ‚Ä¢ ");
}

// ---------- THEME ----------
function applyThemeFromStorage(){
  const saved = localStorage.getItem(THEME_KEY);
  if(saved === "light" || saved === "dark") document.documentElement.setAttribute("data-theme", saved);
}
function toggleTheme(){
  const cur = document.documentElement.getAttribute("data-theme") || "dark";
  const next = (cur === "dark") ? "light" : "dark";
  document.documentElement.setAttribute("data-theme", next);
  localStorage.setItem(THEME_KEY, next);
}

// ---------- INIT ----------
function init(){
  applyThemeFromStorage();
  initFilters();

  // Initial filtered set
  if(progress.session && Array.isArray(progress.session.filteredIds) && progress.session.filteredIds.length){
    state.filteredIds = progress.session.filteredIds.filter(id => Q_BY_ID.has(id));
    state.index = clamp(progress.session.index||0, 0, Math.max(0, state.filteredIds.length-1));
  }else{
    state.filteredIds = QUESTIONS.map(q=>q.id);
  }
  render();

  // Mode
  document.querySelectorAll("input[name=mode]").forEach(r=>{
    r.onchange = (e)=>{
      state.mode = e.target.value;

      // Controls reflect mode immediately (render also handles this)
      byId("submitBtn").disabled = (state.mode==="practice");   // ‚úÖ logic fix
      byId("showExplainBtn").disabled = (state.mode==="exam");
      byId("prevBtn").disabled = (state.mode==="exam");
      byId("nextBtn").disabled = (state.mode==="exam" && state.selectedIndex==null);

      // Reset exam state & timer visibility when switching modes
      byId("examSummary").classList.add("hidden");
      state.examAnswers = {};
      state.examStarted = false;
      stopExamTimer();
      byId("timerPill").classList.add("hidden");

      render();
    }
  });

  // Buttons
  byId("startBtn").onclick = ()=> startSession(false);
  byId("reviewWrongBtn").onclick = ()=> startSession(true);
  byId("shuffleBtn").onclick = ()=>{ shuffle(state.filteredIds); state.index=0; saveSession(); render(); };
  byId("prevBtn").onclick = prevQuestion;
  byId("nextBtn").onclick = nextQuestion;
  byId("submitBtn").onclick = ()=>{
    if(state.mode==="exam"){ submitExamAnswer(); }
    else{ checkAnswer(); }
  };
  byId("showExplainBtn").onclick = ()=>{ if(state.mode!=="exam") toggleExplanation(); };
  byId("flagBtn").onclick = toggleFlag;
  byId("exportBtn").onclick = exportProgress;
  byId("importBtn").onclick = importProgress;
  byId("resetBtn").onclick = resetProgress;
  byId("restartBtn").onclick = ()=>{ state.index=0; state.examAnswers={}; state.examStarted=false; byId("examSummary").classList.add("hidden"); stopExamTimer(); byId("timerPill").classList.add("hidden"); saveSession(); render(); };
  byId("reviewIncorrectBtn").onclick = ()=>{
    // filter to incorrect items from last exam
    const wrong = state.filteredIds.filter(id=> state.examAnswers[id] !== Q_BY_ID.get(id).answer_index );
    if(wrong.length===0){ showToast("No incorrect items to review."); return; }
    state.filteredIds = wrong;
    state.index = 0;
    byId("examSummary").classList.add("hidden");
    // switch to practice review
    state.mode = "practice";
    document.querySelector('input[name=mode][value="practice"]').checked = true;
    // reset timer
    state.examStarted=false; stopExamTimer(); byId("timerPill").classList.add("hidden");
    saveSession();
    render();
  };
  byId("themeBtn").onclick = toggleTheme;
  byId("clearSearch").onclick = ()=>{ byId("searchBox").value=""; startSession(false); };

  // Live filter refresh (debounced search)
  byId("onlyUnseen").onchange = ()=> startSession(false);
  byId("onlyFlagged").onchange = ()=> startSession(false);
  byId("searchBox").addEventListener("input", debounce(()=> startSession(false), 150));

  // Keyboard shortcuts
  window.addEventListener("keydown", (e)=>{
    if(e.target.tagName.toLowerCase()==="input") return;
    const key = e.key;
    if(["1","2","3","4","5"].includes(key)){
      const idx = parseInt(key,10)-1;
      const q = getCurrentQuestion();
      if(!q) return;
      if(idx < q.options.length) selectOption(idx);
    }else if(key==="Enter"){
      if(state.mode==="exam") submitExamAnswer();
      else checkAnswer();
    }else if(key==="ArrowRight"){
      nextQuestion();
    }else if(key==="ArrowLeft"){
      prevQuestion();
    }else if(key.toLowerCase()==="f"){
      toggleFlag();
    }else if(key.toLowerCase()==="e"){
      if(state.mode!=="exam") toggleExplanation();
    }else if(key.toLowerCase()==="r"){
      shuffle(state.filteredIds); state.index=0; saveSession(); render();
    }
  });

  // Theme based on OS if not set
  if(!localStorage.getItem(THEME_KEY) && window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches){
    document.documentElement.setAttribute("data-theme","light");
  }
}

document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
